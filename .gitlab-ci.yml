stages:
  - setup
  - test
  - teardown

include:
  - https://gitlab.invenia.ca/infrastructure/gitlab-ci-helper/raw/master/templates/hidden-jobs.yml
  - https://gitlab.invenia.ca/infrastructure/gitlab-ci-helper/raw/master/templates/teardown.yml

variables:
  STACKNAME_PREFIX: sandbox-awsbatch
  CLOUDSPY_IMAGE: 468665244580.dkr.ecr.us-east-1.amazonaws.com/cloudspy

# Variables that require shell execution or depend on a variable that does
.runtime_variables: &runtime_variables
  |
  # Declare runtime variables
  #
  # Make unique stacks for each executed pipeline for `master`. This will allow fast successive merges
  # to work correctly.
  if [[ ${CI_COMMIT_REF_SLUG} == "master" ]]; then
      STACKNAME="${STACKNAME_PREFIX}-master-${CI_PIPELINE_ID}"
  else
      STACKNAME="${STACKNAME_PREFIX}-${CI_COMMIT_REF_SLUG/\//}"  # Replace an forward slashes with a hyphen
  fi
  ACCOUNT_ID=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep -oP '(?<="accountId" : ")[^"]*(?=")')
  export AWS_DEFAULT_REGION=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep -oP '(?<="region" : ")[^"]*(?=")')

  # Export temp credentials. Make sure this path is absolute as Julia can change directories during testing
  export AWS_SHARED_CREDENTIALS_FILE="$(pwd)/tmp-creds"

.awscli_install: &awscli_install
  |
  # Build cloudspy and its dependencies
  NEED_SUDO="sudo"

  # docker-ci has slightly different install parameters
  if [[ ${CI_RUNNER_TAGS} == *"docker-ci"* ]]; then
    # Install which command
    yum -y install which
    # Install epel to get python36 rather than python3
    amazon-linux-extras install epel
    # We don't need to use sudo on the docker-ci tagged instances
    NEED_SUDO=""
  fi

  # Install python36, virtualenv, and necessary packages
  ${NEED_SUDO} yum -y install python36 python36-devel python-virtualenv gcc git

  # Install a virtualenv with python 3 and activate it
  virtualenv --python=$(which python36) venv
  source venv/bin/activate

  # Install AWSCli
  pip install --upgrade awscli

  # Print aws version
  aws --version

.cloudspy_install: &cloudspy_install
  |
  # Install Cloudspy in the env
  pip install git+https://gitlab-ci-token:${CI_BUILD_TOKEN}@gitlab.invenia.ca/infrastructure/cloudspy.git#egg=cloudspy

.assume_test_profile: &assume_test_profile
  |
  aws-credentials \
    --credentials-file=$AWS_SHARED_CREDENTIALS_FILE \
    --role-arn arn:aws:iam::${ACCOUNT_ID}:role/${STACKNAME}-TestRole \
    --role-session-name test
  export AWS_PROFILE=test


"Setup Environment":
  stage: setup
  except:
    - tags
    - master
    - /^.+\/.*master$/  # e.g. jh/validate-master
  when: always
  environment:
    name: branch/$CI_COMMIT_REF_SLUG
    on_stop: "Delete Environment"
  script:
    - echo "Setting up environment"

"Create Stack":
  stage: setup
  image: $CLOUDSPY_IMAGE
  tags:
    - docker-ci
    - ci-account
  before_script:
    - *runtime_variables
  script:
    - aws cloudformation validate-template --template-body file://test/batch.yml
    - |
      aws-create-stack \
        --role-arn arn:aws:iam::${ACCOUNT_ID}:role/CloudFormationAdmin \
        --stackname $STACKNAME \
        --template-body ./test/batch.yml \
        --wait \
        --params CIRoleArn=arn:aws:iam::${ACCOUNT_ID}:role/GitLabCIRunnerRole

"1.0 (Mac)":
  tags:
    - mac
    - shell-ci
  extends: .test_shell_1_0

"1.0 (Linux, 64-bit)":
  tags:
    - linux
    - 64-bit
    - docker-ci
  extends: .test_docker_1_0

"1.0 (Linux, 32-bit)":
  tags:
    - linux
    - 32-bit
    - shell-ci
  extends: .test_shell_1_0

"1.1 (Mac)":
  tags:
    - mac
    - shell-ci
  extends: .test_shell_1_1

"1.1 (Linux, 64-bit)":
  tags:
    - linux
    - 64-bit
    - docker-ci
  extends: .test_docker_1_1

"1.1 (Linux, 32-bit)":
  tags:
    - linux
    - 32-bit
    - shell-ci
  extends: .test_shell_1_1

"Nightly (Mac)":
  tags:
    - mac
    - shell-ci
  extends: .test_shell_nightly

"Nightly (Linux, 64-bit)":
  tags:
    - linux
    - 64-bit
    - docker-ci
  extends: .test_docker_nightly

"Nightly (Linux, 32-bit)":
  tags:
    - linux
    - 32-bit
    - shell-ci
  extends: .test_shell_nightly


.test_batch:
  stage: test
  tags:
    - amzn2
    - docker-build
    - ci-account
  variables:
    TESTS: "batch"  # Runs the online tests against AWS
  script:
    - *runtime_variables
    - *awscli_install
    - *cloudspy_install
    - *assume_test_profile
    # Execute online tests
    - source julia-ci export
    - AWS_STACKNAME=$STACKNAME ./julia-ci test
    - ./julia-ci coverage
  extends: .test_shell

"1.0 (AWS Batch)":
  variables:
    JULIA_VERSION: "1.0"
  extends: .test_batch

"1.1 (AWS Batch)":
  variables:
    JULIA_VERSION: "1.1"
  extends: .test_batch

# Note: We cannot test AWS Batch on nightly as we don't build "julia-baked" images with
# the nightly Julia revision.


.delete: &delete
  tags:
    - docker-ci
    - ci-account
  image: $CLOUDSPY_IMAGE
  before_script:
    - *runtime_variables
  script:
    - eval $(aws-stack-outputs $STACKNAME)
    - |
      aws cloudformation delete-stack \
        --role-arn arn:aws:iam::${ACCOUNT_ID}:role/CloudFormationAdmin \
        --stack-name $STACKNAME
    - aws cloudformation wait stack-delete-complete --stack-name $STACKNAME

"Delete Environment":
  stage: teardown
  except:
    - tags
    - master
    - /^.+\/.*master$/
  when: manual
  environment:
    name: branch/$CI_COMMIT_REF_SLUG
    action: stop
  dependencies:
    - "Create Stack"
  variables:
    GIT_STRATEGY: none  # Avoid checking out a branch after deletion
  <<: *delete

"Delete Stack":
  stage: teardown
  only:
    - tags
    - master
    - /^.+\/.*master$/
  when: always
  <<: *delete
